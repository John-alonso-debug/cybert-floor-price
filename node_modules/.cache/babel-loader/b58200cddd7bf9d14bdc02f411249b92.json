{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar filter_1 = __importDefault(require(\"./filter\")); //\n// LogFilter\n//\n\n\nvar LogFilter =\n/** @class */\nfunction (_super) {\n  __extends(LogFilter, _super);\n\n  function LogFilter(opts) {\n    var _this = // console.log('LogFilter - new')\n    _super.call(this) || this;\n\n    _this.type = 'log';\n    _this.fromBlock = opts.fromBlock !== undefined ? opts.fromBlock : 'latest';\n    _this.toBlock = opts.toBlock !== undefined ? opts.toBlock : 'latest';\n    var expectedAddress = opts.address && (Array.isArray(opts.address) ? opts.address : [opts.address]);\n    _this.address = expectedAddress && expectedAddress.map(normalizeHex);\n    _this.topics = opts.topics || [];\n    _this.updates = [];\n    _this.allResults = [];\n    return _this;\n  }\n\n  LogFilter.prototype.update = function (logs) {\n    var _this = this; // validate filter match\n\n\n    var validLogs = [];\n    logs.forEach(function (log) {\n      var validated = _this.validateLog(log);\n\n      if (!validated) {\n        return;\n      } // add to results\n\n\n      validLogs.push(log);\n\n      _this.updates.push(log);\n\n      _this.allResults.push(log);\n    });\n\n    if (validLogs.length > 0) {\n      this.emit('data', validLogs);\n    }\n  };\n\n  LogFilter.prototype.getChanges = function () {\n    // console.log('LogFilter - getChanges')\n    return this.updates;\n  };\n\n  LogFilter.prototype.getAllResults = function () {\n    // console.log('LogFilter - getAllResults')\n    return this.allResults;\n  };\n\n  LogFilter.prototype.clearChanges = function () {\n    // console.log('LogFilter - clearChanges')\n    this.updates = [];\n  };\n\n  LogFilter.prototype.validateLog = function (log) {\n    // console.log('LogFilter - validateLog:', log)\n    // check if block number in bounds:\n    // console.log('LogFilter - validateLog - blockNumber', this.fromBlock, this.toBlock)\n    if (blockTagIsNumber(this.fromBlock) && hexToInt(this.fromBlock) >= hexToInt(log.blockNumber)) {\n      return false;\n    }\n\n    if (blockTagIsNumber(this.toBlock) && hexToInt(this.toBlock) <= hexToInt(log.blockNumber)) {\n      return false;\n    } // address is correct:\n    // console.log('LogFilter - validateLog - address', this.address)\n\n\n    if (this.address && !this.address.map(function (a) {\n      return a.toLowerCase();\n    }).includes(log.address.toLowerCase())) {\n      return false;\n    } // topics match:\n    // topics are position-dependant\n    // topics can be nested to represent `or` [[a || b], c]\n    // topics can be null, representing a wild card for that position\n    // console.log('LogFilter - validateLog - topics', log.topics)\n    // console.log('LogFilter - validateLog - against topics', this.topics)\n\n\n    var topicsMatch = this.topics.reduce(function (previousMatched, topicPattern, index) {\n      // abort in progress\n      if (!previousMatched) {\n        return false;\n      } // wild card\n\n\n      if (!topicPattern) {\n        return true;\n      } // pattern is longer than actual topics\n\n\n      var logTopic = log.topics[index];\n\n      if (!logTopic) {\n        return false;\n      } // check each possible matching topic\n\n\n      var subtopicsToMatch = Array.isArray(topicPattern) ? topicPattern : [topicPattern];\n      var topicDoesMatch = subtopicsToMatch.filter(function (subTopic) {\n        return logTopic.toLowerCase() === subTopic.toLowerCase();\n      }).length > 0;\n      return topicDoesMatch;\n    }, true); // console.log('LogFilter - validateLog - '+(topicsMatch ? 'approved!' : 'denied!')+' ==============')\n\n    return topicsMatch;\n  };\n\n  return LogFilter;\n}(filter_1.default);\n\nexports.default = LogFilter;\n\nfunction blockTagIsNumber(blockTag) {\n  return blockTag && ['earliest', 'latest', 'pending'].indexOf(blockTag) === -1;\n}\n\nfunction hexToInt(hexString) {\n  return Number(hexString);\n}\n\nfunction normalizeHex(hexString) {\n  return hexString.slice(0, 2) === '0x' ? hexString : '0x' + hexString;\n}","map":{"version":3,"sources":["/Users/helen/fi/protocol-demo/frontend/node_modules/@bitski/provider-engine/dist/subproviders/filters/log-filter.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__importDefault","mod","__esModule","defineProperty","exports","value","filter_1","require","LogFilter","_super","opts","_this","call","type","fromBlock","undefined","toBlock","expectedAddress","address","isArray","map","normalizeHex","topics","updates","allResults","update","logs","validLogs","forEach","log","validated","validateLog","push","length","emit","getChanges","getAllResults","clearChanges","blockTagIsNumber","hexToInt","blockNumber","a","toLowerCase","includes","topicsMatch","reduce","previousMatched","topicPattern","index","logTopic","subtopicsToMatch","topicDoesMatch","filter","subTopic","default","blockTag","indexOf","hexString","Number","slice"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar filter_1 = __importDefault(require(\"./filter\"));\n//\n// LogFilter\n//\nvar LogFilter = /** @class */ (function (_super) {\n    __extends(LogFilter, _super);\n    function LogFilter(opts) {\n        var _this = \n        // console.log('LogFilter - new')\n        _super.call(this) || this;\n        _this.type = 'log';\n        _this.fromBlock = (opts.fromBlock !== undefined) ? opts.fromBlock : 'latest';\n        _this.toBlock = (opts.toBlock !== undefined) ? opts.toBlock : 'latest';\n        var expectedAddress = opts.address && (Array.isArray(opts.address) ? opts.address : [opts.address]);\n        _this.address = expectedAddress && expectedAddress.map(normalizeHex);\n        _this.topics = opts.topics || [];\n        _this.updates = [];\n        _this.allResults = [];\n        return _this;\n    }\n    LogFilter.prototype.update = function (logs) {\n        var _this = this;\n        // validate filter match\n        var validLogs = [];\n        logs.forEach(function (log) {\n            var validated = _this.validateLog(log);\n            if (!validated) {\n                return;\n            }\n            // add to results\n            validLogs.push(log);\n            _this.updates.push(log);\n            _this.allResults.push(log);\n        });\n        if (validLogs.length > 0) {\n            this.emit('data', validLogs);\n        }\n    };\n    LogFilter.prototype.getChanges = function () {\n        // console.log('LogFilter - getChanges')\n        return this.updates;\n    };\n    LogFilter.prototype.getAllResults = function () {\n        // console.log('LogFilter - getAllResults')\n        return this.allResults;\n    };\n    LogFilter.prototype.clearChanges = function () {\n        // console.log('LogFilter - clearChanges')\n        this.updates = [];\n    };\n    LogFilter.prototype.validateLog = function (log) {\n        // console.log('LogFilter - validateLog:', log)\n        // check if block number in bounds:\n        // console.log('LogFilter - validateLog - blockNumber', this.fromBlock, this.toBlock)\n        if (blockTagIsNumber(this.fromBlock) && hexToInt(this.fromBlock) >= hexToInt(log.blockNumber)) {\n            return false;\n        }\n        if (blockTagIsNumber(this.toBlock) && hexToInt(this.toBlock) <= hexToInt(log.blockNumber)) {\n            return false;\n        }\n        // address is correct:\n        // console.log('LogFilter - validateLog - address', this.address)\n        if (this.address && !(this.address.map(function (a) { return a.toLowerCase(); }).includes(log.address.toLowerCase()))) {\n            return false;\n        }\n        // topics match:\n        // topics are position-dependant\n        // topics can be nested to represent `or` [[a || b], c]\n        // topics can be null, representing a wild card for that position\n        // console.log('LogFilter - validateLog - topics', log.topics)\n        // console.log('LogFilter - validateLog - against topics', this.topics)\n        var topicsMatch = this.topics.reduce(function (previousMatched, topicPattern, index) {\n            // abort in progress\n            if (!previousMatched) {\n                return false;\n            }\n            // wild card\n            if (!topicPattern) {\n                return true;\n            }\n            // pattern is longer than actual topics\n            var logTopic = log.topics[index];\n            if (!logTopic) {\n                return false;\n            }\n            // check each possible matching topic\n            var subtopicsToMatch = Array.isArray(topicPattern) ? topicPattern : [topicPattern];\n            var topicDoesMatch = subtopicsToMatch.filter(function (subTopic) {\n                return logTopic.toLowerCase() === subTopic.toLowerCase();\n            }).length > 0;\n            return topicDoesMatch;\n        }, true);\n        // console.log('LogFilter - validateLog - '+(topicsMatch ? 'approved!' : 'denied!')+' ==============')\n        return topicsMatch;\n    };\n    return LogFilter;\n}(filter_1.default));\nexports.default = LogFilter;\nfunction blockTagIsNumber(blockTag) {\n    return blockTag && ['earliest', 'latest', 'pending'].indexOf(blockTag) === -1;\n}\nfunction hexToInt(hexString) {\n    return Number(hexString);\n}\nfunction normalizeHex(hexString) {\n    return hexString.slice(0, 2) === '0x' ? hexString : '0x' + hexString;\n}\n"]},"metadata":{},"sourceType":"script"}